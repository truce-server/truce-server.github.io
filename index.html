<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Truce Server Sitemap</title>
  <style>
    body { margin:0; font-family: system-ui, Arial; }
    .topbar {
      height:56px; background:#2c9bd6; color:white;
      display:flex; align-items:center; padding:0 16px; gap:16px;
    }
    .topbar .title { font-size:18px; font-weight:600; white-space:nowrap; }
    .topbar input {
      margin-left:auto; width:420px; max-width:50vw;
      border:none; border-radius:18px; padding:10px 12px; outline:none;
    }
    .layout { display:flex; height: calc(100vh - 56px); }
    .sidebar {
      width:320px; border-right:2px solid #d0d7de;
      padding:12px; overflow:auto; background:#f3f6f9;
    }
    .main { flex:1; overflow:hidden; background:white; }
    .section { margin-bottom:12px; }
    .section h3 {
      margin:12px 0 6px; font-size:13px; color:#444;
      text-transform: uppercase; letter-spacing:.05em;
    }
    .item {
      display:block; padding:6px 8px; border-radius:8px;
      color:#0b6aa8; text-decoration:none; word-break:break-word;
    }
    .item:hover { background:#eaf6ff; }
    .hint { color:#666; font-size:14px; padding:8px; }
    iframe { width:100%; height:100%; border:0; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Truce Server • Sitemap</div>
    <input id="search" placeholder="Search pages..." />
  </div>

  <div class="layout">
    <div class="sidebar" id="sidebar">
      <div class="hint">Loading…</div>
    </div>

    <div class="main">
      <iframe id="viewer"
        srcdoc="<h2 style='font-family:system-ui;padding:24px'>Pick a page on the left.</h2>">
      </iframe>
    </div>
  </div>

  <script>
    const sidebar = document.getElementById("sidebar");
    const viewer = document.getElementById("viewer");
    const search = document.getElementById("search");

    let data = {};

    function enc(s){ return encodeURIComponent(s); }

    // Turn your long filenames into clean sidebar labels
    function prettyName(file) {
      let s = file.replace(/\.html$/i, "");

      // Keep only what's after the last " - "
      const parts = s.split(" - ");
      if (parts.length >= 2) s = parts[parts.length - 1];

      // Remove trailing [digits]
      s = s.replace(/\s*\[\d+\]\s*$/, "");

      return s.trim();
    }

    function buildUI(filter="") {
      sidebar.innerHTML = "";
      filter = filter.trim().toLowerCase();

      const folders = Object.keys(data)
        .filter(f => f && !f.startsWith(".") && f !== "workflows") // hide junk
        .sort((a,b)=>a.localeCompare(b));

      if (folders.length === 0) {
        sidebar.innerHTML = "<div class='hint'>No folders found in sitemap.json.</div>";
        return;
      }

      let totalShown = 0;

      for (const folder of folders) {
        const pages = (data[folder] || []).slice().sort((a,b)=>a.localeCompare(b));

        const filtered = filter
          ? pages.filter(p => (folder + " " + p + " " + prettyName(p)).toLowerCase().includes(filter))
          : pages;

        if (filter && filtered.length === 0) continue;

        const sec = document.createElement("div");
        sec.className = "section";

        const h = document.createElement("h3");
        h.textContent = folder;
        sec.appendChild(h);

        if (filtered.length === 0) {
          const empty = document.createElement("div");
          empty.className = "hint";
          empty.textContent = "No pages.";
          sec.appendChild(empty);
        } else {
          for (const file of filtered) {
            const a = document.createElement("a");
            a.className = "item";
            a.textContent = prettyName(file);
            a.href = "#";
            a.onclick = (e) => {
              e.preventDefault();
              viewer.src = `${enc(folder)}/${enc(file)}`;
            };
            sec.appendChild(a);
            totalShown++;
          }
        }

        sidebar.appendChild(sec);
      }

      if (filter && totalShown === 0) {
        sidebar.innerHTML = "<div class='hint'>No results found.</div>";
      }
    }

    fetch("sitemap.json")
      .then(r => {
        if (!r.ok) throw new Error("Missing sitemap.json");
        return r.json();
      })
      .then(json => {
        data = json || {};
        buildUI();
      })
      .catch(() => {
        sidebar.innerHTML = "<div class='hint'>Couldn’t load sitemap.json (make sure it exists in the repo root).</div>";
      });

    search.addEventListener("input", () => buildUI(search.value));
  </script>
</body>
</html>
